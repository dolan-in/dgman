name: dgman-ci

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  ci:
    runs-on: ubuntu-latest
    env:
      DGMAN_TEST_DATABASE: localhost:9080
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
    
    - name: Set up Dgraph
      run: |
        docker run -d --name dgraph-standalone -p 9080:9080 -p 8080:8080 dgraph/standalone:latest
        echo "Waiting for Dgraph to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "Dgraph is ready!"
            break
          fi
          echo "Attempt $i: Dgraph not ready, waiting..."
          sleep 2
        done
        sleep 5

    - name: Run coverage
      run: go test -race -coverprofile=coverage.out -covermode=atomic -p 1 -parallel 1

    - name: Upload coverage to Codecov
      run: bash <(curl -s https://codecov.io/bash)

